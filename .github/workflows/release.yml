name: 跨平台发布构建

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate-tag:
    name: 校验标签格式
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.check.outputs.valid }}
    steps:
      - name: 校验是否为 vX.Y.Z
        id: check
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"
          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "valid=true" >> "$GITHUB_OUTPUT"
            echo "标签格式正确：$TAG"
          else
            echo "valid=false" >> "$GITHUB_OUTPUT"
            echo "::warning::标签 $TAG 不符合 vX.Y.Z（如 v1.0.0），跳过构建和打包。"
          fi

  build-linux:
    name: Linux 打包
    runs-on: ubuntu-latest
    needs: validate-tag
    if: needs.validate-tag.outputs.valid == 'true'
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: 安装 Linux 构建依赖
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libgtk-3-dev libwebkit2gtk-4.1-dev rpm || \
          sudo apt-get install -y build-essential pkg-config libgtk-3-dev libwebkit2gtk-4.0-dev rpm

      - name: 安装 Wails CLI
        shell: bash
        run: |
          go install github.com/wailsapp/wails/v3/cmd/wails3@v3.0.0-alpha.68
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: 执行 Linux 打包
        run: wails3 task package

      - name: 收集 Linux 产物
        shell: bash
        run: |
          mkdir -p release-artifacts/linux
          find bin -maxdepth 1 -type f \( -name "*.AppImage" -o -name "*.appimage" -o -name "*.deb" -o -name "*.rpm" -o -name "*.pkg.tar.zst" -o -name "rocket-leaf" \) -exec cp -v {} release-artifacts/linux/ \;

      - name: 上传 Linux 产物
        uses: actions/upload-artifact@v4
        with:
          name: package-linux
          path: release-artifacts/linux/*
          if-no-files-found: error

  build-macos:
    name: macOS 打包
    runs-on: macos-latest
    needs: validate-tag
    if: needs.validate-tag.outputs.valid == 'true'
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: 安装 Wails CLI
        shell: bash
        run: |
          go install github.com/wailsapp/wails/v3/cmd/wails3@v3.0.0-alpha.68
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: 执行 macOS 打包
        run: wails3 task package

      - name: 收集 macOS 产物
        shell: bash
        run: |
          mkdir -p release-artifacts/macos
          if [ -d "bin/rocket-leaf.app" ]; then
            ditto -c -k --sequesterRsrc --keepParent "bin/rocket-leaf.app" "release-artifacts/macos/rocket-leaf-macos.app.zip"
          fi
          find bin -maxdepth 1 -type f -exec cp -v {} release-artifacts/macos/ \;

      - name: 上传 macOS 产物
        uses: actions/upload-artifact@v4
        with:
          name: package-macos
          path: release-artifacts/macos/*
          if-no-files-found: error

  build-windows:
    name: Windows 打包
    runs-on: windows-latest
    needs: validate-tag
    if: needs.validate-tag.outputs.valid == 'true'
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: 安装 NSIS
        shell: powershell
        run: |
          choco install nsis -y --no-progress
          "C:\\Program Files (x86)\\NSIS" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: 安装 Wails CLI
        shell: powershell
        run: |
          go install github.com/wailsapp/wails/v3/cmd/wails3@v3.0.0-alpha.68
          "$(go env GOPATH)\\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: 执行 Windows 打包
        shell: powershell
        run: wails3 task package

      - name: 收集 Windows 产物
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path release-artifacts/windows | Out-Null
          if (Test-Path bin) {
            Get-ChildItem -Path bin -File | Copy-Item -Destination release-artifacts/windows -Force
          }
          if (Test-Path build/windows/nsis) {
            Get-ChildItem -Path build/windows/nsis -Filter *.exe -File | Copy-Item -Destination release-artifacts/windows -Force
          }

      - name: 上传 Windows 产物
        uses: actions/upload-artifact@v4
        with:
          name: package-windows
          path: release-artifacts/windows/*
          if-no-files-found: error

  release:
    name: 发布 GitHub Release
    runs-on: ubuntu-latest
    needs:
      - validate-tag
      - build-linux
      - build-macos
      - build-windows
    if: needs.validate-tag.outputs.valid == 'true'
    permissions:
      contents: write
    steps:
      - name: 下载全部产物
        uses: actions/download-artifact@v4
        with:
          pattern: package-*
          path: release-files

      - name: 查看产物列表
        shell: bash
        run: |
          echo "将发布以下文件："
          find release-files -type f | sort

      - name: 创建 GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            release-files/**/*
